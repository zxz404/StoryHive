const CACHE_NAME="storyhive-pwa-v6",API_CACHE_NAME="storyhive-api-v2",APP_SHELL_URLS=["/","/index.html","/src/index.html","./index.html","./src/index.html","/styles/styles.css","/src/styles/styles.css","./styles/styles.css","/scripts/pages/app.js","/src/scripts/pages/app.js","./scripts/pages/app.js","/images/Logo.png","/src/public/images/Logo.png","./images/Logo.png","/images/Logo2.png","/src/public/images/Logo2.png","./images/Logo2.png","/images/Logo3.png","/src/public/images/Logo3.png","./images/Logo3.png","/manifest.json","/public/manifest.json","./manifest.json"];async function handleApiRequest(t){const e=await caches.open(API_CACHE_NAME);try{const s=await fetch(t);if(s.ok){const n=s.clone();e.put(t,n)}return s}catch(s){return await e.match(t)||(t.url.includes("/v1/stories")?new Response(JSON.stringify({error:"offline",message:"Anda sedang offline. Data terakhir yang tersedia akan ditampilkan.",listStory:await getCachedStories()}),{status:200,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({error:"offline",message:"Tidak dapat terhubung ke server."}),{status:503,headers:{"Content-Type":"application/json"}}))}}async function handleAppRequest(t){const e=await caches.open(CACHE_NAME),s=new URL(t.url),n=await e.match(t);if(n)return n;try{const s=await fetch(t);if(s.ok){const n=s.clone();e.put(t,n)}return s}catch(n){if("document"===t.destination||"/"===s.pathname){const t=await e.match("/index.html");if(t)return t}return s.pathname.includes(".png")||s.pathname.includes(".jpg")?new Response("",{status:404,headers:{"Content-Type":"text/plain"}}):new Response("",{status:503,headers:{"Content-Type":"text/plain"}})}}async function getCachedStories(){try{const t=await caches.open(API_CACHE_NAME),e=await t.match("https://story-api.dicoding.dev/v1/stories");if(e)return(await e.json()).listStory||[]}catch(t){console.log("Error getting cached stories:",t)}return[]}async function syncStoriesData(){try{const t=await fetch("https://story-api.dicoding.dev/v1/stories");t.ok&&(await caches.open(API_CACHE_NAME)).put("https://story-api.dicoding.dev/v1/stories",t)}catch(t){console.log("Background sync failed:",t)}}self.addEventListener("install",(t=>{t.waitUntil(caches.open(CACHE_NAME).then((t=>t.addAll(APP_SHELL_URLS).catch((t=>{console.log("Failed to cache:",t)})))).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(t=>{t.waitUntil(caches.keys().then((t=>Promise.all(t.map((t=>{if(t!==CACHE_NAME&&t!==API_CACHE_NAME)return caches.delete(t)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(t=>{const{request:e}=t,s=new URL(e.url);"GET"===e.method&&("story-api.dicoding.dev"!==s.hostname?s.origin!==self.location.origin||t.respondWith(handleAppRequest(e)):t.respondWith(handleApiRequest(e)))})),self.addEventListener("sync",(t=>{"storyhive-data-sync"===t.tag&&t.waitUntil(syncStoriesData())})),self.addEventListener("push",(t=>{let e={title:"StoryHive",body:"Anda memiliki notifikasi baru",icon:"/images/favicon.png",badge:"/images/favicon.png"};if(t.data)try{const s=t.data.json();e={...e,...s}}catch(s){e.body=t.data.text()||e.body}const s={body:e.body,icon:e.icon,badge:e.badge,vibrate:[200,100,200]};t.waitUntil(self.registration.showNotification(e.title,s))})),self.addEventListener("notificationclick",(t=>{t.notification.close(),t.waitUntil(clients.matchAll({type:"window"}).then((t=>{for(const e of t)if(e.url.includes(self.location.origin))return e.focus();if(clients.openWindow)return clients.openWindow(self.location.origin)})))}));