const CACHE_NAME="storyhive-pwa-v4",API_CACHE_NAME="storyhive-api-v1",APP_SHELL_URLS=["/","/index.html","/src/index.html","/styles/styles.css","/src/styles/styles.css","/scripts/pages/app.js","/src/scripts/pages/app.js","/scripts/utils/push-notification.js","/src/scripts/utils/push-notification.js","/scripts/data/api.js","/src/scripts/data/api.js","/images/Logo.png","/src/public/images/Logo.png","/images/favicon.png","/src/public/images/favicon.png","/manifest.json","/public/manifest.json"];async function handleApiRequest(t){const e=await caches.open(API_CACHE_NAME);try{const s=await fetch(t);if(s.ok){const n=s.clone();e.put(t,n).catch((t=>{console.log("Cache put failed for API:",t)}))}return s}catch(s){return await e.match(t)||(t.url.includes("/v1/stories")?new Response(JSON.stringify({error:"offline",message:"Anda sedang offline. Data terakhir yang tersedia akan ditampilkan.",listStory:await getCachedStories()}),{status:200,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({error:"offline",message:"Tidak dapat terhubung ke server."}),{status:503,headers:{"Content-Type":"application/json"}}))}}async function handleAppShellRequest(t){const e=await caches.open(CACHE_NAME),s=await e.match(t);if(s)return s;try{const s=await fetch(t);return s.ok&&e.put(t,s.clone()).catch((t=>{console.log("Cache put failed:",t)})),s}catch(e){return"document"===t.destination?caches.match("/"):new Response("Network error",{status:408})}}async function handleDefaultRequest(t){try{return await fetch(t)}catch(e){const s=await caches.open(CACHE_NAME);return await s.match(t)||new Response("Offline",{status:503})}}function isAppShellRequest(t){const e=new URL(t.url);return APP_SHELL_URLS.some((s=>{try{return new URL(s,self.location.origin).pathname===e.pathname}catch{return t.url.includes(s)}}))}async function getCachedStories(){try{const t=await caches.open(API_CACHE_NAME),e=await t.match("https://story-api.dicoding.dev/v1/stories");if(e)return(await e.json()).listStory||[]}catch(t){console.log("Error getting cached stories:",t)}return[]}async function syncStoriesData(){try{const t=await fetch("https://story-api.dicoding.dev/v1/stories");t.ok&&(await caches.open(API_CACHE_NAME)).put("https://story-api.dicoding.dev/v1/stories",t)}catch(t){console.log("Background sync failed:",t)}}self.addEventListener("install",(t=>{t.waitUntil(caches.open(CACHE_NAME).then((t=>t.addAll(APP_SHELL_URLS).catch((t=>{console.log("Cache addAll failed:",t)})))).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(t=>{t.waitUntil(caches.keys().then((t=>Promise.all(t.map((t=>{if(t!==CACHE_NAME&&t!==API_CACHE_NAME)return caches.delete(t)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(t=>{const{request:e}=t,s=new URL(e.url);"GET"===e.method&&"chrome-extension:"!==s.protocol&&("story-api.dicoding.dev"!==s.hostname?isAppShellRequest(e)?t.respondWith(handleAppShellRequest(e)):t.respondWith(handleDefaultRequest(e)):t.respondWith(handleApiRequest(e)))})),self.addEventListener("sync",(t=>{"storyhive-data-sync"===t.tag&&t.waitUntil(syncStoriesData())})),self.addEventListener("push",(t=>{let e={title:"StoryHive",body:"Anda memiliki notifikasi baru",icon:"/images/favicon.png",badge:"/images/favicon.png",tag:"storyhive-general",url:"#/home",actions:[{action:"open",title:"Buka Aplikasi"},{action:"close",title:"Tutup"}]};if(t.data)try{const s=t.data.json();e={...e,...s}}catch(s){e.body=t.data.text()||e.body}const s={body:e.body,icon:e.icon,badge:e.badge,tag:e.tag,data:{url:e.url,timestamp:(new Date).toISOString(),source:"storyhive"},actions:e.actions,vibrate:[200,100,200],requireInteraction:!0};t.waitUntil(self.registration.showNotification(e.title,s))})),self.addEventListener("notificationclick",(t=>{const e=t.notification,s=t.action,n=(e.data||{}).url||"#/home";e.close(),"close"!==s&&t.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((t=>{for(const e of t)if(e.url.includes(self.location.origin))return"focus"in e&&e.focus(),void(n&&e.url!==n&&e.postMessage({type:"NAVIGATE_TO_URL",url:n}));if(clients.openWindow)return clients.openWindow(self.location.origin+n)})))}));